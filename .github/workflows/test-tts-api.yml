name: Test TTS API

on:
  push:
    branches: [main]
    paths: [python/**]
  pull_request:
    branches: [main]
    paths: [python/**]

jobs:
  test-api:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: python

    steps:
      - uses: actions/checkout@v4

      - uses: astral-sh/setup-uv@v6
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: uv sync --frozen --no-dev

      - name: Cache model weights
        uses: actions/cache@v4
        with:
          path: ~/.cache/huggingface
          key: hf-qwen3-tts-0.6b-customvoice

      - name: Download model
        run: uv run huggingface-cli download Qwen/Qwen3-TTS-12Hz-0.6B-CustomVoice

      - name: Start server
        run: |
          MODEL_PATH="Qwen/Qwen3-TTS-12Hz-0.6B-CustomVoice" \
            QWEN_TTS_DEVICE=cpu \
            QWEN_TTS_DTYPE=float32 \
            QWEN_TTS_ATTN="" \
            HOST=127.0.0.1 \
            PORT=8000 \
            uv run python main.py &

          for i in $(seq 1 60); do
            if curl -s --max-time 2 http://127.0.0.1:8000/health > /dev/null 2>&1; then
              echo "Server is ready"
              break
            fi
            echo "Waiting for server... ($i)"
            sleep 10
          done

      - name: Generate English audio
        run: |
          curl -s -X POST http://127.0.0.1:8000/v1/audio/speech \
            -H "Content-Type: application/json" \
            -d '{
              "model": "qwen3-tts",
              "input": "Hello, this is a test of the Qwen text to speech API.",
              "voice": "Ryan",
              "language": "English",
              "response_format": "wav"
            }' \
            --output output_english.wav \
            --max-time 600 \
            -w "HTTP %{http_code}, %{size_download} bytes\n"

      - name: Generate Chinese audio
        run: |
          curl -s -X POST http://127.0.0.1:8000/v1/audio/speech \
            -H "Content-Type: application/json" \
            -d '{
              "model": "qwen3-tts",
              "input": "欢迎使用通义千问语音合成接口。",
              "voice": "Sohee",
              "language": "Chinese",
              "response_format": "wav"
            }' \
            --output output_chinese.wav \
            --max-time 600 \
            -w "HTTP %{http_code}, %{size_download} bytes\n"

      - name: Stop server
        run: kill $(lsof -t -i:8000) 2>/dev/null || true

      - name: Verify audio files
        run: |
          uv run python -c "
          import soundfile as sf
          for f in ['output_english.wav', 'output_chinese.wav']:
              info = sf.info(f)
              print(f'{f}: {info.duration:.2f}s, {info.samplerate} Hz')
              assert info.duration > 0, f'{f} has no audio'
          print('All files valid')
          "

      - name: Upload audio artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tts-audio-samples
          path: |
            python/output_english.wav
            python/output_chinese.wav
